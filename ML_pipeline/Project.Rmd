---
title: "Project - Predicting Mortality in ICU Patients"
author: "Lucie Gillet, Maja Garbulinska, Anthony O'Brien, Mathew Samuel"
date: "12/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(caTools)
library(caret)
library(tidyverse)
library(lubridate)
library(Amelia) 
library(stringr)
```

# Overview and Motivation:
###Provide an overview of the project goals and the motivation for it. Consider that this will be read by people who did not see your project proposal

With the proliferation of data, there continues to be a shift towards data-driven decision making, especially in the world of healthcare. The ICU represents a particularly interesting opportunity given the numerous data elements collected on patients to monitor their health at this critical juncture in their health. Currently, there are a variety of risk prediction scores that clinicians are able to utilize to gain some insight into the overall health of their patient in the aggregate. 

For our project, we wanted to see if we could take advantage of the many data points collected and develop a mortality prediction model based on a patient's first day in the ICU, which remains a particularly important period in their hospital admission. Such a model would provide physicians with a data-driven, standardized approach to assess the overall health of their patient and also potentially inform clinical decision-making moving forward. For instance, though it may be heuristically clear at times which patients might need increased supervision, a robust and standardized score would provide for a systematic, process-driven method to help hospitals allocate resources on patients that require the most attention. 

# Related Work: 
###Anything that inspired you, such as a paper, a web site, or something we discussed in class

We were inspired by a paper written by our MIT course faculty on [Real-time mortality prediction in the Intensive Care Unit](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5977709/). We wanted to tackle a relevant and feasible problem given the scope of the class, so decided to modify the task to develop a mortality prediction based on first day measurements. 

# Initial Questions: 
###What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

The main question we are trying to answer is as follows: can we accurately predict a patient's in-hospital mortality based on their first-day readings in the ICU? Over the course of our project, we also wondered if we could understand the impact of the first 24 hours in the ICU on longer-term patient mortality, though it's clear that as more time passes from the initial ICU stay to the time of death, there could be additional factors to take into account, a number of which do not have corresponding data. After working with the data, we also faced the challenge of dealing with patients who were admitted to the ICU at multiple time points, sometimes within the same hospital admission. [[[[[[[[[[[[[[[To focus our analysis, we decided to analyze the first ICU stay when there were multiple ICU stays ?????????]]]]]]]]]]]]]]]

As we continued our analysis, we also wondered whether we should incorporate current scores that we aim to compare against in our model. In the end, we decided that these were acceptable to incorporate considering that these readings are automatically calculated for patients in the ICU and more importantly, these scores provided an effective proxy in helping us understand the nuance of clinical values in the absence of additional clinical expertise. If this model were to be implemented in the future, it would be important to incorporate some of the scores and buckets created in different scoring methods to accurately convey information on how 'good' or 'bad' certain values are. 

In the course of our analysis, one of the greatest challenges we faced was thinking about how we would deal with missing data. While we did initially consider looking at various imputation methods, we decided to develop a parsimonious model with reasonable accuracy given the variety of challenges of imputation in a clinical setting after consulting various clinicians and given the time frame of the project.  

# Data: 
##Source, scraping method, cleanup, etc

For our Collaborative Data Science in Medicine class, the MIMIC database was hosted in Google Bigquery. We developed sql queries and then combined the dataframe into a temporary folder provisioned in bigquery, from which we imported the data into R with a connection. As we cannot provide account access and for the sake of reproducibility, we placed an extract of the query result in an Rda file to analyze going forward. 

# Exploratory Analysis: 
###What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?

We first used a variety of exploratory plots, including histograms and barplots to understand the distribution of our data to identify outliers, missing data and the shape of distributions to potentially inform further methods. At our core, our research question is a classification problem, so we decided to use logistic regression along with tree based methods, including first a simple decision tree, then a random forest and a gradient boosted tree.  

# Final Analysis: What did you learn about the data? How did you answer the questions? How can you justify your answers?

We learned that we are able to develop a reasonable estimate with just first day readings in the ICU, but need to incorporate additional complexity in order to effectively implement this algorithm in a clinical setting. [WRITE SOMETHING ABOUT HOW WE THOUGHT ABOUT TYPE I VS TYPE II ERROR]. As mentioned at the beginning, we sought to develop a decision support tool, and believe that our algorithm could be used to help clinicians better understand a patient's future prognosis. [COMPARED TO PREVIOUS OR CURRENTLY USED SCORES]. 

```{r}
##df <- read.csv(file='../data/260_1123cohort.csv',sep=',', header=TRUE, quote="\'", check.names = FALSE)
load('../data/hds_1213.Rda')

#mat's file path
#FIGURE OUT IF THERE's A WAY TO DYNAMICALLY GENERATE PATH BASED ON GIT.. worst case we can use a dropbox 
#load('C:/Users/Samuel/Documents/fall18/260/finalproj1213/bst260/data/cohort_1204.Rda')
hds<-hds %>% unique() # make sure we dont have duplicates 
```

time since last ICU admission (taking 1/number of days since the last icu stay. People who are in the ICU for the first time will get 0)
We also remove patients with missing values for intime and outtime, because their ICU stay might just be an entry error.

```{r}
subset_hds<- hds %>% select(subject_id, hadm_id, icustay_id, intime, outtime) %>%
  arrange(subject_id, intime) %>% 
  group_by(subject_id) %>% 
  mutate(lag=lag(intime, 1)) %>%
  mutate(difftime=difftime(intime, lag, units="days")) %>%
  mutate(difftime=1/as.numeric(difftime)) %>%
  mutate(difftime=ifelse(is.na(difftime),0,difftime)) %>%
  mutate(isnaintime=ifelse(is.na(intime), 1, 0)) %>%
  mutate(max=max(isnaintime))%>%
  filter(max!=1)%>%
  select(-c(subject_id, icustay_id, difftime))%>%
  ungroup()
  

hds2<-left_join(hds, subset_hds)
```

Remove people with missing gender
```{r}
hds2<-hds2 %>% filter(!is.na(gender))
```

Remove all the columns with more than 20% of missing values 
```{r}
threshold <- nrow(hds)*0.20
hds <- hds[colSums(is.na(hds)) < threshold]
```

remove patients who have missing values for the rest of the columns 
```{r}
hds <- hds[rowSums(is.na(hds)) < 1,]
```

First, we exclude all the patients who do not meet our inclusion criteria. Due to physiological differences, we exclude everyone who is under 18 years old. We also dummify gender and remove people with missing gender. These are errors. 

```{r}
hds <- hds %>% filter(age>=18) %>% 
  filter(is.nagender)
  mutate(age = ifelse(age>89, 92, age),
         gender=ifelse(gender=="F", 1,0)) ## female is 1
```


Pre-processing categorical variable into 0vs1 columns and making dummies:
```{r}
hds<-hds %>% 
  mutate(gender=ifelse(gender=='"F"', 1,0),# 1 is female and 0 is male
         first_icu_stay=ifelse(first_icu_stay==FALSE,0,1),
         v=1, # needed to make dummies 
         admission_type=paste("AdmissionType",admission_type,sep="_")) %>% 
  mutate(first_icu_stay=ifelse(first_icu_stay==FALSE,0,1)) %>%
  spread(admission_type, v, fill = 0) %>%
  filter(age>17) %>% ## leave only adults 
  unique() %>% ## unique entries 
  mutate(urineoutput=abs(urineoutput)) %>% ## we have negative values. I change them to positive
  
```





This is the distribution of age now: 

```{r}
plot1<- ggplot()+
  geom_histogram(aes(x=age), data=hds, colour="grey")+
  theme_bw()+
  ggtitle("Age distribution")
plot1
```

```{r}
plot2<- ggplot()+
  geom_histogram(aes(x=as.character(age_score)), data=hds, colour="grey", stat="count")+
  theme_bw()+
  ggtitle("Age distribution")+
  xlab("Age score")
plot2
```

Older individuals above 90 are assigned to 7, for a more logical interpretation we assign these individuals to 12 to more accurately reflect the demographics. 

```{r}
hds<- hds %>%
  mutate(age_score=ifelse(age_score==7,12,age_score)) 


plot3<-hds %>%
  ggplot()+
  geom_histogram(aes(x=as.factor(age_score)), data=hds, colour="grey", stat="count")+
  theme_bw()+
  ggtitle("Age distribution")+
  xlab("Age score")
plot3
```

